# Safety pipeline and drift behavior

## Staged low-speed safety
- The low-speed safety controller evaluates yaw rate and slip angle against profile-specific limits and reports a severity score. A severity above `1.0` forces the emergency stage and latches until speed rises above the release speed without another trip. Transition blending is applied between the engage/release bands to ease back toward nominal dynamics before unlatching.【F:lib/simulation/low_speed_safety.cpp†L63-L117】【F:lib/simulation/low_speed_safety.cpp†L119-L170】
- Three stages are exposed through telemetry: `normal`, `transition`, and `emergency`. The daemon surfaces the current stage, severity, and whether the detector forced engagement so hosts can render or log the safety status.【F:lib/telemetry/telemetry.cpp†L269-L288】【F:lib/telemetry/telemetry.cpp†L20-L35】

## Loss-of-control detector thresholds
- The loss-of-control detector compares instantaneous yaw rate, slip angle, lateral acceleration, and wheel slip ratios against magnitude and rate-of-change thresholds, returning the maximum normalized severity across all monitored signals.【F:lib/simulation/loss_of_control_detector.cpp†L32-L78】 The detector retains previous samples to track rates and clears its state on reset.【F:lib/simulation/loss_of_control_detector.cpp†L20-L31】【F:lib/simulation/loss_of_control_detector.cpp†L48-L61】
- Default thresholds are tuned per model family in `config/loss_of_control_detector.yaml` (e.g., the single-track drift profile uses yaw-rate 1.4 rad/s and slip-ratio 0.22 defaults, while the double-track model uses lower values). When swapped into the daemon, the detector thresholds mirror the model-specific key chosen during initialization.【F:config/loss_of_control_detector.yaml†L1-L42】【F:config/loss_of_control_detector.yaml†L43-L72】

## Drift-capable models vs. normal profiles
- Drift-capable models ship with the drift safety profile enabled by default (`drift_enabled: true` in `config/low_speed_safety_std.yaml`), granting higher yaw-rate and slip-angle limits plus a slightly lower engage speed so the vehicle can pivot into oversteer without latching early.【F:config/low_speed_safety_std.yaml†L1-L11】
- Other models start in the normal profile (`config/low_speed_safety.yaml`) and must opt into drift mode via initialization, reset parameters, or a `UserInput` drift toggle at runtime. Switching profiles reinitializes the latch and recomputes the active thresholds, so hosts should reset their expectations when flipping modes.【F:config/low_speed_safety.yaml†L1-L11】【F:lib/simulation/low_speed_safety.cpp†L38-L59】

## Tuning guidance for future models
- Start from the closest existing profile in `config/loss_of_control_detector.yaml` and adjust magnitude thresholds until typical yaw/slip excursions during aggressive maneuvers fall below `1.0` severity while pathological spikes exceed it. Keep rate thresholds proportional to the fastest realistic rise time of each signal to avoid false trips from gradual inputs.【F:lib/simulation/loss_of_control_detector.cpp†L62-L99】
- Pair detector tuning with low-speed safety profiles: set `engage_speed` just above the speed where the model becomes numerically unstable, and keep `release_speed` high enough to require a clean recovery before unlatching. Use higher yaw/slip limits in the drift profile only if the model exhibits stable oversteer; otherwise mirror the normal limits to prevent runaway spins.【F:lib/simulation/low_speed_safety.cpp†L82-L146】【F:config/low_speed_safety.yaml†L1-L11】
- Validate changes via the telemetry fields `detector_severity`, `safety_stage`, and `low_speed_engaged`. The `examples/drift_mode_demo` sample logs these values while executing brake-and-steer maneuvers, providing a repeatable sanity check for CI when experimenting with new thresholds.【F:examples/drift_mode_demo.cpp†L58-L109】【F:lib/telemetry/telemetry.cpp†L269-L288】
